apex.model={},function(e,t,n,r,i){"use strict";var s={},a=[],o=100,d=10,l=i.extend,h=i.isArray,c=i.isPlainObject,u=i.isFunction,f=i.Deferred;function g(e){if("string"==typeof e)return[e,null];if(h(e)&&2===e.length&&"string"==typeof e[0]&&(null===e[1]||"string"==typeof e[1]))return e;throw new Error("Invalid model id")}function _(e){var t,n;if(h(e)){for(n=[],t=0;t<e.length;t++)n.push(_(e[t]));return n}return c(e)?l(!0,{},e):e}function p(e,t,n){var r,i=e._listeners;for(r=0;r<i.length;r++)i[r].onChange(t,n)}function y(e,t,n,r,i){e?t.call(e,n,r,i):t(n,r,i)}function v(e){return"string"==typeof e?e:h(e)?1===e.length?""+e[0]:JSON.stringify(e):e.toString()}function I(e,t){var n,s=[],a=[];function o(e){var t,n,r=e._listeners;for(t=0;t<r.length;t++)(n=r[t].progressView)&&n[0]&&n[0].offsetWidth&&n[0].offsetHeight&&(s.push(n),a.push(r[t].progressOptions||null))}if(o(e),t)for(n=0;n<t.length;n++)o(t[n]);return 0===s.length?null:e._options.makeLoadingIndicator?e._options.makeLoadingIndicator(s,a):function(){var e,t,n=i();for(e=0;e<s.length;e++)t=r.showSpinner(s[e],a[e]),n=n.add(t);return function(){n.remove()}}}function m(e,t,n,r){var i,s;return s=e,r&&(s+=" Server status: "+r),i=new Error(s),t.status>=0&&(i.status=t.status),i}function w(e,t){var n,r;for(n in delete e.error,delete e.warning,delete e.message,e.fields)e.fields.hasOwnProperty(n)&&(r=e.fields[n],t||(delete r.changed,delete r.stale),delete r.error,delete r.warning,delete r.message)}function R(e,t,n,r,i){return-1===t&&(t=0),-1===n&&(n=t+e*r),t+(n-t)/(r+1)*i}function F(e){return new Error("Model has invalid shape for the "+e+" method")}function x(e,t){var n,r=e,i=t;if(null!==e&&"object"==typeof e&&e.hasOwnProperty("v")&&(r=e.v,null!==t&&"object"==typeof t&&t.hasOwnProperty("v")&&(i=t.v)),h(r)&&h(i)){if(r.length!==i.length)return!1;for(n=0;n<r.length;n++)if(r[n]!=i[n])return!1;return!0}return r==i}function K(e,t,n){var r,i,s,a;for(r in t)t.hasOwnProperty(r)&&((i=t[r]).volatile||i.virtual||"string"==typeof(a=e[s=n?i.index:r])&&(e[s]=a.replace(/\r\n/g,"\n")))}function b(e,t,n,r,i){var s,a,o,d,l,h,c,u,f,g,_,y=e._options,v=t.record,I=e._getIdentity(v),m=[];for(function t(n,r,i){var s,a,o,d;for(s=0;s<n.length;s++)a=n[s],(o=y.fields[a])&&!r[a]&&(o.dependsOn&&t(o.dependsOn,r,i),r[a]||!o.calcValue&&!o.dependsOn||(i.push(a),r[a]=1,(d=e._dependentFields[a])&&t(d,r,i)))}(n,i||{},m),s=0;s<m.length;s++)if(o=m[s],(d=y.fields[o]).calcValue){for(f=[],a=0;a<d.dependsOn.length;a++)g=":"===(c=d.dependsOn[a]).substr(0,1)?apex.item(c.substr(1)).getValue():e.getValue(v,c),f.push(g);if(_=d.calcValue(f,e,v),l=e.getFieldKey(o),t.fields&&t.fields[o]&&t.fields[o].ck)throw new Error("Set calculated value not allowed for field.");x(h=v[l],_)||(v[l]=_,t.fields||(t.fields={}),(u=t.fields[o])||(u={},t.fields[o]=u),u.changed=!0,r&&p(e,"set",{oldValue:h,oldIdentity:null,recordId:I,record:v,field:o}),e._checkAggregates(o))}else(u=t.fields[o])||(u={},t.fields[o]=u),u.stale=!0,r&&e.metadataChanged(I,o)}function D(e,t){var n,r,i={},s=t.record,a=[];for(n=0;n<e._calculatedFields.length;n++)r=e._calculatedFields[n],null==s[e.getFieldKey(r)]?a.push(r):i[r]=1;a.length>0&&b(e,t,a,!1,i)}var O=/^\s*([+-]?(?:(?:[0-9]+\.[0-9]*)|(?:\.[0-9]+))(?:[eE][+-]?[0-9]+)?[fFdD]?|[+-]?[0-9]+)\s*$/;function C(e){return""===e||null===e?null:"string"==typeof e&&O.test(e)?parseFloat(e):"number"==typeof e?e:NaN}var M={SUM:{name:"SUM",init:function(e,t){if(t&&"NUMBER"!==t)throw new Error("Wrong data type for SUM aggregate");e.total=0,e.grandTotal=0},add:function(e,t){null===(t=C(t))||isNaN(t)||(e.total+=t,e.grandTotal+=t)},get:function(e,t){var n=t?e.total:e.grandTotal;return t&&(e.total=0),n}},AVG:{name:"AVG",init:function(e,t){if(t&&"NUMBER"!==t)throw new Error("Wrong data type for AVG aggregate");e.total=0,e.grandTotal=0,e.count=0,e.totalCount=0},add:function(e,t){null===(t=C(t))||isNaN(t)||(e.total+=t,e.grandTotal+=t,e.count+=1,e.totalCount+=1)},get:function(e,t){var n=t?e.total/e.count:e.grandTotal/e.totalCount;return t&&(e.total=0,e.count=0),n}},MAX:{name:"MAX",init:function(e,t){e.dataType=t,e.max=null,e.overallMax=null},add:function(e,t){"NUMBER"===e.dataType?t=C(t):t.d&&(t=t.d),null===t||""===t.toString().trim()||isNaN(t)||((null===e.max||t>e.max)&&(e.max=t),(null===e.overallMax||t>e.overallMax)&&(e.overallMax=t))},get:function(e,t){var n=t?e.max:e.overallMax;return t&&(e.max=null),n}},MIN:{name:"MIN",init:function(e,t){e.dataType=t,e.min=null,e.overallMin=null},add:function(e,t){"NUMBER"===e.dataType?t=C(t):t.d&&(t=t.d),null===t||""===t.toString().trim()||isNaN(t)||((null===e.min||t<e.min)&&(e.min=t),(null===e.overallMin||t<e.overallMin)&&(e.overallMin=t))},get:function(e,t){var n=t?e.min:e.overallMin;return t&&(e.min=null),n}},MEDIAN:{name:"MEDIAN",init:function(e,t){e.values=[],e.allValues=[]},add:function(e,t){null===(t=C(t))||isNaN(t)||(e.values.push(t),e.allValues.push(t))},get:function(e,t){var n,r=t?e.values:e.allValues,i=r.length;return r.sort((function(e,t){return e-t})),n=i%2==0?(r[i/2]+r[i/2-1])/2:r[(i-1)/2],t&&(e.values=[]),n}},COUNT:{name:"COUNT",init:function(e){e.count=0,e.totalCount=0},add:function(e,t){t.v&&(t=t.v),null!==t&&""!==t.toString().trim()&&(e.count+=1,e.totalCount+=1)},get:function(e,t){var n=t?e.count:e.totalCount;return t&&(e.count=0),n}},COUNT_DISTINCT:{name:"COUNT_DISTINCT",init:function(e){e.count=0,e.totalCount=0,e.distinctValues={}},add:function(e,t){t.v&&(t=t.v),null!==t&&""!==t.toString().trim()&&(e.distinctValues[t]||(e.count+=1,e.totalCount+=1),e.distinctValues[t]=1)},get:function(e,t){var n=t?e.count:e.totalCount;return t&&(e.count=0),n}}},S={modelId:function(){return null===this.instance?this.name:[this.name,this.instance]},fetch:function(e,t,n){var r,i,s,a,o,d,h,c,u,g=this,_=this._options,p=f();if("number"!=typeof e&&(n=t,t=e,e=0),"table"===_.shape){if(c=e,u=_.pageSize,h=Math.floor(c/u)*u,e=function(e){var t,n=g._data;if(0===e)return 0;for(t=e;t<n.length&&void 0!==n[t];t++);return t}(h),this._haveAllData&&e>=this._data.length||this._masterRecordIsInserted||this._masterRecordIsDeleted)return!1;d=this._getServerOffset(e),(o=h+_.pageSize-e)<_.pageSize&&void 0===this._data[h+_.pageSize]&&(o+=_.pageSize),a={version:_.version,firstRow:d+1,maxRows:o}}else a={version:_.version};return this._requestsInProgress.fetch?null:(i={regions:[l({},_.regionData,{id:_.regionId,ajaxIdentifier:_.ajaxIdentifier,fetchData:l({},_.fetchData,a)})]},_.pageItemsToSubmit&&(i.pageItems=_.pageItemsToSubmit),this._addParentItems(i.regions[0]),s=l({},_.requestOptions),n?delete s.loadingIndicator:s.loadingIndicator=I(this),this._requestsInProgress.fetch=!0,this._callServer(i,s).done((function(t){var n,r=null,i=null,s=null,a=null,o=null;delete g._requestsInProgress.fetch,g._requestsInProgress.abortFetch?(delete g._requestsInProgress.abortFetch,p.reject(m("Error: Aborted when model cleared",{status:0}))):(n=t.regions[0].fetchedData,"table"===_.shape?(r=n.values,i=n.totalRows,s=n.firstRow-1,a=n.moreData,o=n.dataOverflow):"tree"===_.shape?r=n.root:"record"===_.shape&&(r=n.value),g._addData(e,s,r,i,a,o),p.resolve())})).fail((function(e,t,n){delete g._requestsInProgress.fetch,p.reject(m("Error retrieving data.",e,0,n))})),r=p.promise(),t&&r.always(t),r.always((function(e){g._drainWaiters(e)})),r)},fetchAll:function(e){var t=this,n=0,r=this._options,i=r.pageSize;if("table"!==r.shape)throw F("fetchAll");for(;this._data[n];)n+=1;!function r(){var s=t.fetch(n,(function(s){s?e({error:s}):(e({offset:n,total:t.getTotalRecords(),done:!1}),n+=i,r())}),!0);null===s?setTimeout((function(){r()}),500):!1===s&&e({offset:n,total:t.getTotalRecords(),done:!0})}()},fetchRecords:function(e,t){var n,r,i,s,a,o,d=this,h=this._options,c=[],u=f();if("record"===h.shape)throw F("fetchRecords");if(void 0===this._identityKeys)throw new Error("Model must have identityField defined");for(n=0;n<e.length;n++)r=this._getIdentity(e[n]),(i=this.getRecordMetadata(r))&&!i.inserted&&c.push({recordId:r,pk:this._getPrimaryKey(e[n])});return 0===c.length?null:(a={regions:[l({},h.regionData,{id:h.regionId,ajaxIdentifier:h.ajaxIdentifier,fetchData:l({},h.fetchData,{version:h.version,primaryKeys:c})})]},h.pageItemsToSubmit&&(a.pageItems=h.pageItemsToSubmit),this._addParentItems(a.regions[0]),o=l({},h.requestOptions,{loadingIndicator:I(this)}),this._callServer(a,o).done((function(e){var t;t=e.regions[0].fetchedData.values,d._updateData(t),u.resolve()})).fail((function(e,t,n){u.reject(m("Error retrieving data.",e,0,n))})),s=u.promise(),t&&s.always(t),s)},save:function(e){var t,n,r,i,s,a=this._options,o=f();return s=l({},a.requestOptions,{loadingIndicator:I(this)}),i={},(n=this.addChangesToSaveRequest(i))?(n(t=this._callServer(i,s)),t.done((function(e){e.errors?o.reject(e.errors):o.resolve(null,e)})).fail((function(e,t,n){o.reject(m("Error saving data.",e,0,n))})),r=o.promise(),e&&r.always(e),r):null},saveInProgress:function(){return!!this._requestsInProgress.save},addChangesToSaveRequest:function(e){var t,n,r,i,s,a,o,d,c,u,f=this,g=this._options,p=this._metaKey,y=[],v=[],I={},m=[],w=0;function R(){delete f._requestsInProgress.save,f._changes=f._pendingChanges.concat(f._changes)}function F(e){var t,n,r,i,s,a,o,d=e.record;for(a=e.inserted&&!e.originalId,n=g.recordIsArray?[]:{},t=0;t<v.length;t++)null!==(r=d[i=v[t]])&&"object"==typeof r&&r.hasOwnProperty("v")&&(r=r.v),o=I[i],e.fields&&e.fields[o]&&e.fields[o].disabled&&(r=""),!a||!f.isIdentityField(o)||e.original&&r!==e.original[i]||(r=""),"string"==typeof r&&(r=r.replace(/\n/g,"\r\n")),g.recordIsArray?n.push(_(r)):n[i]=_(r);s=null,e.deleted?s="d":e.inserted?s="i":e.updated&&(s="u"),n[p]||(n[p]={}),s&&(n[p].op=s),n[p].recordId=f._getIdentity(d),e.originalId&&(n[p].originalId=e.originalId),g.saveSelection&&(n[p].sel=e.sel?"Y":"N"),m.push(n)}if(g.pageItemsToSubmit&&((i=e.pageItems)||(i=[],e.pageItems=i),h(i)))for(s=g.pageItemsToSubmit,h(s)||(s=s.replace(/#/g,"").split(/\s*,\s*/)),t=0;t<s.length;t++)i.indexOf(s[t])<0&&i.push(s[t]);if(this._requestsInProgress.save||0===this._changes.length&&!g.saveSelection)return null;for(t in g.fields)g.fields.hasOwnProperty(t)&&((n=g.fields[t]).virtual||(w+=1),n.volatile||n.virtual||(r=g.recordIsArray?n.index:t,v.push(r),I[r]=t,g.recordIsArray&&n.index===this._metaKey&&(p=v.length-1)));for(g.recordIsArray&&v.sort((function(e,t){return e-t})),p||(p=g.recordIsArray?v.length:"_meta"),t=0;t<this._changes.length;t++)(a=this._changes[t]).autoInserted&&!a.updated&&y.push(a.record);for(y.length&&this.deleteRecords(y),t=0;t<this._changes.length;t++)F(a=this._changes[t]);if(this._pendingChanges=this._changes,this._changes=[],g.saveSelection)for(t in this._selection)this._selection.hasOwnProperty(t)&&((a=this._selection[t]).inserted||a.deleted||a.updated||F(a));for((o=e.regions)||(e.regions=o=[]),t=0;t<o.length&&(d=o[t]).id!==g.regionId;t++)d=null;return d||(d=l({},g.regionData,{id:g.regionId,ajaxIdentifier:g.ajaxIdentifier,saveData:{models:[]}}),o.push(d)),c=d.saveData.models,u=l({},g.saveData,{instance:this.instance,version:g.version,values:m}),this._addParentItems(u),c.push(u),this._requestsInProgress.save=!0,function(e){e.done((function(e){var t,n,r,i,s,a,o;if(f._requestsInProgress.abortSave)delete f._requestsInProgress.abortSave,R();else if(e.errors){for(t=0;t<e.errors.length;t++)(a=e.errors[t]).regionStaticId===g.regionStaticId&&a.recordId&&a.instance==f.instance&&f.setValidity("error",a.recordId,a.columnName||null,a.message);R()}else if(e.regions){for(s=null,t=0;t<e.regions.length;t++){if((r=e.regions[t]).id===g.regionId){for(i=r.fetchedData.models,n=0;n<i.length;n++)if(i[n].instance==f.instance){s=i[n].values,f._metaKey||(o=g.recordIsArray?w:"_meta"),f._updateData(s,o);break}break}r=null}f._clearChanges("_pendingChanges")}delete f._requestsInProgress.save})).fail((function(e,t,n){R()}))}},setData:function(e,t){t=t||0,this._addData(t,t,e,e?e.length:null,!1,!1),p(this,"refresh",{})},clearData:function(){this._clear(),p(this,"refresh",{})},getTotalRecords:function(){var e,t,n=this._options;if("table"===n.shape)return this._haveAllData||"none"===n.paginationType?this._data.length:this._totalRecords<0?this._totalRecords:Math.max(this._data.length,this._totalRecords);if("record"===n.shape)return 1;if("tree"===n.shape){for(e in t=0,this._index)this._index.hasOwnProperty(e)&&(t+=1);return t}},getServerTotalRecords:function(){var e=this._options;return"table"===e.shape?this._totalRecords<0?this._totalRecords:this._totalRecords+this._numInsertedRecords-this._numDeletedRecords:"record"===e.shape?1:"tree"===e.shape?-1:void 0},getDataOverflow:function(){return!!this.dataOverflow},forEach:function(e,t){var n,r,i,s=this,a=this._options,o=this._data;if("record"===a.shape)throw F("forEach");if("tree"===a.shape)n=0,o&&this.walkTree(o,{node:function(r){y(t,e,r,n,s._getIdentity(r)),n+=1}});else for(i=o.length,n=0;n<i;n++)(r=o[n])&&y(t,e,r,n,this._getIdentity(r,n))},transform:function(e,t){var n,r,i,s,a,o=/^\[\W*([^ \t\/]+)\W*\]$/,d=e.template,l=e.showNullAs,c=d.length,f=[],g={},_=this;function p(e,t){var n;return(n=e[t])||(n={values:{},paths:[]},e[t]=n),n}function y(e,t,n,r,i,s){var a,d,l,c,u,f,g,_;if(e){for(u=e.split("/"),f=r,g=null,_=null,l=null,a=0;a<u.length;a++){if(l=u[a],d=o.exec(l)){p(s,d[1]).paths[t]=u.slice(a+1).join("/");break}g=f,_=l,f.hasOwnProperty(l)||(f[l]={}),f=f[l]}g?(h(g[_])?(c=g[_]).length=0:c=[],g[_]=c):c=r,i[t]=c}else{if(!h(r))throw new Error("Context must be an array when there is no path");i[t]=r}n&&p(s,n)}function v(e,n,r,i){var s,a,o,d,c=!1;return"string"==typeof e?(s=e.length,o=e.charAt(0),d=e.charAt(s-1),"'"===o&&"'"===d?e.substring(1,s-1):("("===o&&")"===d&&(e=e.substring(1,s-1),c=!0),null!==(a=_.getValue(n,e))&&"object"==typeof a&&a.hasOwnProperty("d")&&(a=c?a.v:a.d),c||!l||null!==a&&""!==a||(a=l),a)):u(e)?e.call(t,_,n,r,i):null===e?e:h(e)?function(e,t,n,r,i){var s,a;for(s=0;s<e.length;s++)void 0!==(a=v(e[s],n,r,i))&&(t[s]=a);return t}(e,[],n,r,i):"object"==typeof e?function(e,t,n,r,i){var s,a;for(s in e)e.hasOwnProperty(s)&&void 0!==(a=v(e[s],n,r,i))&&(t[s]=a);return t}(e,{},n,r,i):void 0}function I(e,t,n,r){var i,s,a,d=[];if(e)for(e=e.split("/"),i=0;i<e.length;i++)s=e[i],(a=o.exec(s))&&d.push({key:a[1],value:v(a[1],t,n,r)});return d}function m(n,r,i){var o,l,h,u,m,w,R,F,x,K,b;if(!(r<s||a>0&&r>=s+a)&&(e.includeAggregates||!_._metaKey||!n[_._metaKey].agg)&&(!e.filter||e.filter.call(t,_,n,r,i)))for(o=0;o<c;o++)if(w=null,h=d[o],u=f[o],!h.filter||h.filter.call(t,_,n,r,i)){if(h.uniqueIndexField&&(w=g[h.uniqueIndexField],R=v(h.uniqueIndexField,n,r,i),void 0!==w.values[R]))continue;if(void 0!==(m=v(h.item,n,r,i))){if(w)w.values[R]={index:u.length,arrays:[],indexes:{}};else for(F=I(h.path,n,r,i),b=g,l=0;l<F.length;l++)void 0===(x=(w=p(b,F[l].key)).values[F[l].value])&&(x={index:u.length,arrays:[],indexes:{}},K=""===w.paths[o]?[]:{},u.push(K),w.values[F[l].value]=x),K=u[x.index],x.arrays[o]||y(w.paths[o],o,null,K,x.arrays,x.indexes),u=x.arrays[o],b=x.indexes;u.push(m)}}}for(null!==t&&"object"==typeof t||(t={}),function(){var e,n;for(e=0;e<d.length;e++)y((n=d[e]).path,e,n.uniqueIndexField,t,f,g)}(),s=0,e.offset>=0&&(s=e.offset),a=e.fetchData?this._options.pageSize:null,e.count>0&&(a=e.count),e.fetchData?this.forEachInPage(s,a,m):this.forEach(m),n=0;n<c;n++)r=d[n],i=f[n],r.sort&&i.array.sort(r.sort);return t},forEachInPage:function(e,t,r,i){var s,a,o,d,l=e,h=this,c=this._options,u=this._data;function f(s){var a=t-(s-e);n.trace("Model: "+h.modelId()+". forEachInPage fetching more data starting at: ",s),h._waitingPages.push({offset:s,callback:r,thisArg:i,next:function(){h.forEachInPage(s,a,r,i)}}),h._requestsInProgress.fetch||h.fetch(s,(function(e){e||setTimeout((function(){h._waitingPages.length>0&&h._waitingPages.shift().next()}),1)}))||(h._waitingPages.pop(),y(i,r,null,-1,null))}if("table"!==c.shape)throw F("forEachInPage");if(t>c.pageSize&&(c.pageSize=10*Math.floor((t+9)/10)),"one"===c.paginationType&&(l=e-this._offset),l<0||l>=u.length)this._haveAllData?(y(i,r,null,-1,null),this._drainWaiters()):f(e);else{for(a=l+t,d=e,s=l;s<a;s++){if(void 0===(o=u[s]))return void(this._haveAllData&&s>=u.length?(y(i,r,null,-1,null),this._drainWaiters()):f(s+this._offset));o&&(y(i,r,o,d,this._getIdentity(o,s)),d+=1)}this._drainWaiters()}},indexOf:function(e){var t,n=this._options;if("record"===n.shape)throw F("indexOf");return"tree"===n.shape?(t=this.getRecordMetadata(this._getIdentity(e)))&&t.parent?t.parent[this._childrenKey].indexOf(e):-1:this._data.indexOf(e)},recordAt:function(e){if("table"!==this._options.shape)throw F("recordAt");return this._data[e]||null},getRecordId:function(e){return this._getIdentity(e)},getAggregateRecord:function(e,t){var n,r,i,s,a=null;if(t>=0){if(i=this._breakEndIds[t],(n=this.indexOf(this.getRecord(i)))>=0)for(s=!1;n<this._data.length;n++)if((r=(a=this._data[n])[this._metaKey])&&r.agg){if(s=!0,r.agg===e)break}else if(s){a=null;break}}else for(n=this._data.length-1;n>=0;n--){if(!((r=(a=this._data[n])[this._metaKey])&&r.agg&&r.grandTotal)){a=null;break}if(r.agg===e)break}return a},isIdentityField:function(e){return void 0!==this._identityKeys&&this._identityKeys.indexOf(this.getFieldKey(e))>=0},getRecordMetadata:function(e){return this._index[v(e)]||null},metadataChanged:function(e,t){var n=this._index[v(e)];n&&p(this,"metaChange",{record:n.record,recordId:e,field:t||null})},getTypeMetadata:function(e){return this._options.types[e]||null},getFieldMetadata:function(e){return this._options.fields[e]||null},getFieldKey:function(e){var t=this._options;if(t.fields.hasOwnProperty(e)&&!t.fields[e].virtual)return t.recordIsArray?t.fields[e].index:e},isChanged:function(){var e,t,n;if(0===this._changes.length)return!1;for(n=0,e=0;e<this._changes.length;e++)(t=this._changes[e]).autoInserted&&!t.updated||(n+=1);return n>0},getChanges:function(){return this._changes},clearChanges:function(){this._clearChanges("_changes")},hasErrors:function(){return this._errors.length>0},getErrors:function(){return this._errors},setSelectionState:function(e,t){var n=v(e),r=this._index[n];r&&(t=!!t,r.sel!==t&&(r.sel=t,t?(this._selection[n]=r,this._selectionCount+=1):(delete this._selection[n],this._selectionCount-=1)))},clearSelection:function(){var e;for(e in this._selection)this._selection.hasOwnProperty(e)&&(this._selection[e].sel=!1);this._selection={},this._selectionCount=0},getSelectedCount:function(){return this._selectionCount},getSelectedRecords:function(){var e,t=this._selection,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(t[e].record);return n},allowEdit:function(e){return this.check("canEdit",e)},allowDelete:function(e){var t=this._options;return"record"!==t.shape&&("tree"!==t.shape||e!==this._data)&&this.check("canDelete",e)},allowAdd:function(e,t,n){var r,i,s,a,o=this._options;if("record"===o.shape)return!1;if(!("tree"!==o.shape||e&&e[this._childrenKey]))return!1;if((s=this.check("canAdd",e,t,n))&&n&&"tree"===o.shape&&!0!==(i=void 0!==(a=this._getType(e)).validChildren?a.validChildren:void 0===o.types.default.validChildren||o.types.default.validChildren))for(r=0;r<n.length;r++)if(i.indexOf(n[r][this._typeKey])<0){s=!1;break}return s},allowDrag:function(e){return"record"!==this._options.shape&&this.check("canDrag",e)},dragOperations:function(e){var t,n,r,i=this._options;if(e){if(e.length>0&&this._typeKey){for(r=e[0][this._typeKey]||"default",t=1;t<e.length;t++)if((e[t][this._typeKey]||"default")!==r){r="default";break}}else r="default";n=i.types[r].operations&&void 0!==i.types[r].operations.drag?i.types[r].operations.drag:i.types.default.operations.drag}else n=i.types.default.operations.externalDrag;return n},check:function(e,t,n,r){var i,s=!1,a=this._options,o=this._getType(t);if(!a.editable||this._masterRecordIsDeleted)return!1;if(t&&(i=this.getRecordMetadata(this._getIdentity(t)))){if(i.deleted||i.agg)return!1;if(i.inserted&&("canEdit"===e||"canDelete"===e))return!0}return i&&void 0!==i[e]?s=i[e]:o.operations&&void 0!==o.operations[e]?s=o.operations[e]:void 0!==a.types.default.operations[e]&&(s=a.types.default.operations[e]),u(s)&&(s=s.call(this,t,n,r)),u(a.check)&&(s=a.check(s,e,t,n,r)),s},getValue:function(e,t){return void 0===t&&(t=e,e=this._data),e[this.getFieldKey(t)]},setValue:function(e,t,n,r){var i,s,a,o,d,l,c,u,f,g,y,v,I,m=this._options,w=!1;if(void 0===n&&(n=t,t=e,e=this._data),a=this.getFieldKey(t),!this.allowEdit(e))throw new Error("Set value not allowed for record.");if(c=this._getIdentity(e),!(o=this.getRecordMetadata(c)))return null;if(I=m.fields[t],void 0===a||I.readonly&&!I.parentField||o.fields&&o.fields[t]&&o.fields[t].ck)throw new Error("Set value not allowed for field.");if(!x(s=e[a],n)){if(!r&&(t===m.sequenceField||t===m.parentIdentityField))if(u=f=g=null,t===m.sequenceField){if("tree"===m.shape?(f=this.parent())&&(u=f[this._childrenKey]):u=this._data,u)for(i=0;i<u.length&&!(parseFloat(u[i][this._sequenceKey])>parseFloat(n));i++)g=u[i]}else t===m.parentIdentityField&&(f=this.getRecord(n));if(o.original||(o.original=function(e){var t,n;if(h(e))for(n=[],t=0;t<e.length;t++)n[t]=_(e[t]);else for(t in n={},e)e.hasOwnProperty(t)&&(n[t]=_(e[t]));return n}(e),w=!0),e[a]=n,(l=this._getIdentity(e))!==c){if(this._index[l])return e[a]=s,w&&delete o.original,"DUP";o.originalId||(o.originalId=c),delete this._index[c],this._index[l]=o,o.sel&&(delete this._selection[c],this._selection[l]=o)}return o.updated||o.deleted||o.inserted||this._addChange(o),o.updated=!0,o.fields||(o.fields={}),(d=o.fields[t])||(d={},o.fields[t]=d),d.changed=!0,(o.error||o.warning)&&this.setValidity("valid",l),p(this,"set",{oldValue:s,oldIdentity:l!==c?c:null,recordId:l,record:e,field:t}),this._checkAggregates(t),(y=this._dependentFields[t])&&(I.calcValue&&((v={})[t]=1),b(this,o,y,!0,v)),(f||g)&&this.moveRecords([e],f,g),"SET"}return"NC"},getRecordValue:function(e,t){return this.getValue(this.getRecord(e),t)},setRecordValue:function(e,t,n){this.setValue(this.getRecord(e),t,n)},setValidity:function(e,t,n,r){var i,s,a,o,d,l,h,c=this._index[v(t)];if(c&&(n?(c.fields||(c.fields={}),(a=c.fields[n])||(a={},c.fields[n]=a)):a=c,l="valid",h=a.message||r,a.warning&&(l="warning"),a.error&&(l="error"),e!==l||h!==r)){switch(e){case"error":s="error",delete a.warning;break;case"warning":s="warning",delete a.error;break;case"valid":delete a.error,delete a.warning,delete a.message;break;default:throw new Error("Invalid value for pValidity parameter: "+e)}if(s&&(a[s]=!0,a.message=r),!(o=c.error)&&c.fields)for(i in c.fields)if(c.fields.hasOwnProperty(i)&&c.fields[i].error){o=!0;break}o?((d=this._errors.indexOf(c))>=0&&this._errors.splice(d,1),this._errors.push(c)):this._removeError(c),this.metadataChanged(t,n)}},deleteRecords:function(e){var t,r,i,s,a=[],o=[],d=this._options;if("record"===d.shape)throw F("deleteRecords");for(t=0;t<e.length;t++)s=e[t],i=this._getIdentity(s),(r=this.getRecordMetadata(i))?this.allowDelete(s)?("table"===d.shape&&(this._numDeletedRecords+=1),d.onlyMarkForDelete&&!r.inserted||("table"===d.shape&&r.inserted&&(this._numDeletedRecords-=1,this._numInsertedRecords-=1),this._removeRecord(i,r)),r.inserted?(delete r.inserted,delete r.autoInserted,delete r.updated,this._removeError(r),this._removeChange(r)):(w(r,!0),this._removeError(r),r.deleted=!0,this._addChange(r)),a.push(s),o.push(i)):n.warn("Delete not allowed for record: "+i):n.warn("Record to delete not found: "+i);return a.length>0&&(p(this,"delete",{records:a,recordIds:o}),this._checkAggregates()),a.length},canRevertRecord:function(e){var t;return!(!(t=this.getRecordMetadata(this._getIdentity(e)))||!t.original&&!t.deleted)},revertRecords:function(e){var t,r,i,s,a,o,d={},l=[],h=[],c=this._options;for(t=0;t<e.length;t++)i=e[t],s=this._getIdentity(i),(r=this.getRecordMetadata(s))?r.original||r.deleted?("table"===c.shape?a=this._data:"tree"===c.shape&&(a=this.parent(r.record)[this._childrenKey]),o=a.indexOf(r.record),r.deleted?("table"===c.shape&&(this._numDeletedRecords-=1),delete r.deleted):(r.originalId&&(this._index[r.originalId]=r,delete this._index[s],r.sel&&(this._selection[r.originalId]=r,delete this._selection[s]),d[s]=r.originalId,delete r.originalId),r.original&&(r.record=r.original,delete r.original),delete r.updated,w(r),this._removeError(r)),this._removeChange(r),i=r.record,a[o]!==i&&(a[o]=i),l.push(i),h.push(s)):n.warn("Nothing to revert for record "+s):n.warn("Record to revert not found: "+s);return l.length>0&&(p(this,"revert",{records:l,recordIds:h,newIds:d}),this._checkAggregates()),l.length},insertNewRecord:function(e,t,n){var r,i,s,a,o,d,l,h=this._options,c=null;if("record"===h.shape)throw F("insertNewRecord");if(a=this._initRecord(n,null,e),!this.allowAdd(e,"new",[a]))throw new Error("Insert not allowed for new record.");return o="tree"===h.shape?e?e[this._childrenKey]:this._data[this._childrenKey]:this._data,i=0,t&&(c=this._getIdentity(t),(r=this.getRecordMetadata(c))&&(i=o.indexOf(r.record)+1)),this._sequenceKey&&(d=l=-1,i-1>=0&&(d=parseFloat(o[i-1][this._sequenceKey])),i<o.length&&(l=parseFloat(o[i][this._sequenceKey])),a[this._sequenceKey]=""+R(h.sequenceStep,d,l,1,1)),o.splice(i,0,a),s=this._getIdentity(a),r={record:a,inserted:!0},this._index[s]=r,this._addChange(r),"tree"===h.shape?r.parent=e:this._numInsertedRecords+=1,D(this,r),p(this,"insert",{record:a,recordId:s,insertAfterId:c}),s},moveRecords:function(e,t,r){var i,s,a,o,d,l,h,c,u,f,g=this._options,_=[],y=[],v=null;if("record"===g.shape)throw F("moveRecords");for("tree"===g.shape?(t||(t=this._data),o=t[this._childrenKey]):o=this._data,a=0,r&&(v=this._getIdentity(r),(s=this.getRecordMetadata(v))&&(a=o.indexOf(s.record)+1),(!s||a<0)&&(n.warn("AfterRecord not found, move to beginning."),a=0)),this._sequenceKey&&(u=f=-1,a-1>=0&&(u=parseFloat(o[a-1][this._sequenceKey])),a<o.length&&(f=parseFloat(o[a][this._sequenceKey]))),i=0;i<e.length;i++)if(h=e[i],c=this._getIdentity(h),s=this.getRecordMetadata(c)){if("tree"===g.shape){if(!(d=this.parent(h))){n.warn("Move not allowed for root");continue}d=d[this._childrenKey]}else d=o;l=d.indexOf(h),d.splice(l,1),o===d&&l<a&&(a-=1),y.push(h),_.push(c),o.splice(a,0,h),a+=1,this._sequenceKey&&this.setValue(h,g.sequenceField,""+R(g.sequenceStep,u,f,e.length,i+1),!0),"tree"===g.shape&&(s.parent=t,this._parentIdKey&&this.setValue(h,g.parentIdentityField,this._getIdentity(t),!0))}else n.warn("Record to move not found: "+c);return p(this,"move",{records:y,recordIds:_,insertAfterId:v}),_},copyRecords:function(e,t,r){var i,s,a,o,d,l,h,c,u,f,g,_=this,y=this._options,v=[],I=[],m=null;if("record"===y.shape)throw F("copyRecords");for("tree"===y.shape?(u={node:function(e,t){var n,r;t&&(n=_._getIdentity(e),r={record:e,inserted:!0,parent:t},_._index[n]=r,_._addChange(r))}},t||(t=this._data),h=t[this._childrenKey]):h=this._data,a=0,r&&(m=this._getIdentity(r),(s=this.getRecordMetadata(m))&&(a=h.indexOf(s.record)+1),(!s||a<0)&&(n.warn("AfterRecord not found, copy to beginning."),a=0)),this._sequenceKey&&(f=g=-1,a-1>=0&&(f=parseFloat(h[a-1][this._sequenceKey])),a<h.length&&(g=parseFloat(h[a][this._sequenceKey]))),i=0;i<e.length;i++)o=e[i],l=this._getIdentity(o),(s=this.getRecordMetadata(l))?(d=this._initRecord(null,e[i],t),h.splice(a,0,d),a+=1,this._sequenceKey&&(d[this._sequenceKey]=""+R(y.sequenceStep,f,g,e.length,i+1)),c=this._getIdentity(d),I.push(d),v.push(c),s={record:d,inserted:!0},this._index[c]=s,this._addChange(s),"tree"===y.shape?(s.parent=t,this.walkTree(d,u,null)):this._numInsertedRecords+=1):n.warn("Record to copy not found: "+l);return p(this,"copy",{records:I,recordIds:v,insertAfterId:m}),this._checkAggregates(),v},root:function(){if("tree"!==this._options.shape)throw F("root");return this._data},child:function(e,t){var n=e[this._childrenKey];if(n)return n[t]},parent:function(e){var t,n;if(this._identityKeys&&(t=this._getIdentity(e),(n=this.getRecordMetadata(t))&&n.hasOwnProperty("parent")))return n.parent?n.parent:null},childCount:function(e){var t=e[this._childrenKey];return null===t?null:t?t.length:0},hasChildren:function(e){var t=e[this._childrenKey];return null===t?null:!!t&&t.length>0},fetchChildNodes:function(e,t){var n,r,i,s=this,a=this._options,o=f();return r={regions:[l({},a.regionData,{id:a.regionId,ajaxIdentifier:a.ajaxIdentifier,fetchData:l({},a.fetchData,{version:a.version,parentId:this._getPrimaryKey(e)})})]},a.pageItemsToSubmit&&(r.pageItems=a.pageItemsToSubmit),this._addParentItems(r.regions[0]),i=l({},a.requestOptions,{loadingIndicator:I(this)}),this._callServer(r,i).done((function(t){var n=t[s._childrenKey];s._addData(e,null,n),o.resolve(n.length)})).fail((function(e,t,n){o.reject(m("Error retrieving data.",e,0,n))})),n=o.promise(),t&&n.always(t),n},clearChildNodes:function(e){e[this._childrenKey];e[this._childrenKey]=null},walkTree:function(e,t,n){var r,i,s,a;if(void 0===n&&(n=null,(i=this._getIdentity(e))&&(s=this.getRecordMetadata(i))&&(n=s)),!t.node(e,n)&&(a=e[this._childrenKey])&&a.length>0){for(t.beginChildren&&t.beginChildren(e),r=0;r<a.length;r++)this.walkTree(a[r],t,e);t.endChildren&&t.endChildren(e)}},subscribe:function(e){var t=e.viewId;return t||(t="v::"+o,o+=1,e.viewId=t),this._listeners.push(e),t},unSubscribe:function(e){var t;for(t=0;t<this._listeners.length;t++)this._listeners[t].viewId===e&&this._listeners.splice(t,1)},getOption:function(e){var t=this._options[e];if(void 0===t)throw new Error("No such option: "+e);return t},setOption:function(e,t){if({genIdPrefix:1,pageItemsToSubmit:1,fetchData:1,saveData:1,regionData:1,requestOptions:1,parentRecordId:1,editable:1,pageSize:1}[e]){if("editable"===e&&!this._options.identityField)throw new Error("An editable model requires an identityField");this._options[e]=t}else n.warn("Option cannot be set: "+e)},_callServer:function(e,n){return(this._options.callServer||t.plugin)(e,n)},_drainWaiters:function(e){var t,n;for(t=0;t<this._waitingPages.length;t++)if(n=this._waitingPages[t],(this._haveAllData||this._data[n.offset]||e)&&(this._waitingPages.splice(t,1),t-=1,e&&0!==e.status?y(n.thisArg,n.callback,null,-1,null):n.next(),this._requestsInProgress.fetch))return},_getServerOffset:function(e){var t,n,r,i=e-1;for(r=this._data[i];r;){if(t=this._getIdentity(r,i),(n=this.getRecordMetadata(t))&&n.serverOffset>=0)return n.serverOffset+1;i-=1,r=this._data[i]}return e},_clear:function(){var e=this._options;this._requestsInProgress.fetch&&(this._requestsInProgress.abortFetch=!0),this._requestsInProgress.save&&(this._requestsInProgress.abortSave=!0),"table"===e.shape?(this._data=[],e.hasTotalRecords?this._totalRecords=0:this._totalRecords=-1,this._haveAllData=!1,this._offset=0,this._numInsertedRecords=0,this._numDeletedRecords=0,this._masterRecordIsInserted&&(this._haveAllData=!0),this.dataOverflow=!1):this._data=null,this._changes=[],this._errors=[],this._index={},this._breakEndIds=[],this._selection={},this._selectionCount=0},_saveDataState:function(){this._saveState={_data:this._data,_totalRecords:this._totalRecords,_haveALlData:this._haveAllData,_offset:this._offset,_numInsertedRecords:this._numInsertedRecords,_numDeletedRecords:this._numDeletedRecords,dataOverflow:this.dataOverflow,_changes:this._changes,_errors:this._errors,_index:this._index,_breakEndIds:this._breakEndIds,_selection:this._selection,_selectionCount:this._selectionCount}},_restoreDataState:function(){var e=this._saveState;this._data=e._data,this._totalRecords=e._totalRecords,this._haveALlData=e._haveAllData,this._offset=e._offset,this._numInsertedRecords=e._numInsertedRecords,this._numDeletedRecords=e._numDeletedRecords,this.dataOverflow=e.dataOverflow,this._changes=e._changes,this._errors=e._errors,this._index=e._index,this._breakEndIds=e._breakEndIds,this._selection=e._selection,this._selectionCount=e._selectionCount},_clearChanges:function(e){var t,n,r,i=[],s=[],a=this._options,o=this[e];for(t=0;t<o.length;t++)n=o[t],r=this._getIdentity(n.record),n.deleted&&a.onlyMarkForDelete&&this._removeRecord(r,n),n.deleted?i.push(r):(n.inserted||n.updated)&&s.push(r),delete n.deleted,delete n.recordId,delete n.inserted,delete n.autoInserted,delete n.updated,delete n.original;this[e]=[],p(this,"clearChanges",{deletedIds:i,changedIds:s})},_addData:function(e,t,r,i,s,a){var o,d,h,c,u,f,g,_,y,v,I,m,w,R,F=this._options,x=this,b=this._calculatedFields.length>0;function O(e,t,n){var r={record:n};x._metaKey&&(l(r,n[x._metaKey]),r.sel="Y"===r.sel,r.agg&&(!e||x._identityKeys&&!n[x._identityKeys[0]])&&(x._assignTempIdentity(n),e=x._getIdentity(n)),r.allowedOperations&&(r.canEdit=!!r.allowedOperations.update,r.canDelete=!!r.allowedOperations.delete)),null!=t&&(r.serverOffset=t),x._index[e]=r,r.sel&&(x._selected[e]=r),K(n,F.fields,F.recordIsArray),b&&!r.agg&&D(x,r)}function C(e,t,n){var r,i,s,a,o,d;for(s=0,r=0;r<x._aggregateRecs.length;r++)t[i=x._aggregateRecs[r]]||(o=x._initRecord(!1),d={agg:i},n&&(d.grandTotal=n),o[x._metaKey]=d,a=e+s,x._data[a]?x._data.splice(a,0,o):x._data[a]=o,O(null,null,o),s+=1);return s}function M(){if(x._data.length>0&&x._haveAllData&&x._aggregateRecs.length>0){if(w){if(f&&f.grandTotal)for(o=x._data.length-1;o>=0&&(h=x._data[o],(f=x._metaKey&&h[x._metaKey])&&f.agg&&f.grandTotal);o--);C(o+1,R)}(o=C(x._data.length,R,!0))>0&&x._checkAggregates()}}if("table"===F.shape?((0===e&&!this.isChanged()||"none"===F.paginationType)&&this._clear(),"one"===F.paginationType&&(this._offset=e),this._totalRecords=-1,null!=i?this._totalRecords=i:F.hasTotalRecords&&n.warn("Model missing total records"),this._haveAllData||s||(this._haveAllData=!0),a&&(this.dataOverflow=!0)):"record"===F.shape&&this._clear(),"tree"===F.shape&&e)(_=e)[this._childrenKey]=r,F.identityField&&x.walkTree(_,{node:function(e,t){var n;t&&(O(n=x._getIdentity(e),null,e),x.getRecordMetadata(n).parent=t)}},null),p(this,"addData",{parentNode:_,offset:0,count:r.length});else if(null===this._data||0===this._data.length||"table"!==F.shape||"one"===F.paginationType){if(n.trace("Model: "+this.modelId()+". add data set: ",e,i,s),this._data=r,this._numInsertedRecords=0,this._numDeletedRecords=0,"record"!==F.shape)if(I={offset:0,count:r.length},y=t,"tree"===F.shape&&this.root()&&F.identityField)this.walkTree(this.root(),{node:function(e,t){c=x._getIdentity(e),x._metaKey&&h[x._metaKey].agg?v=null:(v=y,y+=1),O(c,v,e),x.getRecordMetadata(c).parent=t}},null),I.parentNode=null,I.count=1;else{for(w=!1,R={},o=0;o<this._data.length;o++)h=this._data[o],c=this._getIdentity(h,o),(f=this._metaKey&&h[this._metaKey])&&f.agg?(v=null,R[f.agg]=1):(v=y,y+=1,w&&(o+=C(o,R)),w=!1),f&&f.endControlBreak&&(this._breakEndIds.push(c),this._aggregateRecs.length>0&&(w=!0,R={})),O(c,v,h);M()}else F.identityField&&this._data?(I={offset:0,count:1},O(this._getIdentity(this._data),null,this._data)):I={offset:0,count:this._data?1:0};p(this,"addData",I)}else{for(n.trace("Model: "+this.modelId()+". add data merge: ",e,i,s),d=e,y=t,m=[],w=!1,R={},o=0;o<r.length;o++){if(h=r[o],c=this._getIdentity(h,d),(f=this._metaKey&&h[this._metaKey])&&f.agg?(v=null,R[f.agg]=1):(v=y,y+=1),g=this.getRecordMetadata(c)){if(g.updated||g.inserted||g.deleted)continue;u=this._data.indexOf(g.record),this._data[u]=h,K(h,F.fields,F.recordIsArray),g.record=h,g.serverOffset=v,f&&l(g,f),m.push(c),b&&!g.agg&&D(this,g)}else this._data[d]?this._data.splice(d,0,h):this._data[d]=h,d+=1,O(c,v,h);f&&(f.agg||(w&&(d+=C(d,R)),w=!1),f.endControlBreak&&(this._breakEndIds.push(c),this._aggregateRecs.length>0&&(w=!0,R={})))}M(),I={offset:e,count:d-e},m.length&&(I.replacedIds=m),p(this,"addData",I)}},_updateData:function(e,t){var n,r,i,s,a,o,d=this._options,h=!1,c=[],u=[],f=[],g=[],_={},y=t||this._metaKey;for(n=0;n<e.length;n++)s=(o=(r=e[n])[y])?o.recordId:null,o&&s&&o.notFound?(a=this.getRecordMetadata(s),this._removeRecord(s,a),f.push(a.record),g.push(s)):(s===(i=this._getIdentity(r))&&(s=null),(a=this.getRecordMetadata(s||i))&&(s&&(_[s]=i,this._index[i]=a,delete this._index[s],delete this._selection[s],this._selectionCount-=1),c.push(r),u.push(s||i),this._data[this._data.indexOf(a.record)]=r,K(r,d.fields,d.recordIsArray),a.record=r,y&&o?(l(!0,a,o),a.allowedOperations&&(a.canEdit=!!a.allowedOperations.update,a.canDelete=!!a.allowedOperations.delete),delete a.recordId):t&&(d.recordIsArray?r.splice(t,1):delete r[t]),D(this,a),delete a.deleted,delete a.inserted,delete a.autoInserted,delete a.updated,delete a.original,w(a),this._removeError(a),this._removeChange(a)));c.length>0&&(p(this,"refreshRecords",{records:c,recordIds:u,newIds:_}),h=!0),f.length>0&&(p(this,"delete",{records:f,recordIds:g}),h=!0),h&&this._checkAggregates()},_initRecord:function(t,n,r){var i,s,a,o,d,l,h,c,u,f,g=!0,_=this._options;if(t)l=t;else for(i in!1===t&&(g=!1),l=_.recordIsArray?[]:{},_.fields)if(_.fields.hasOwnProperty(i)&&(s=_.fields[i],a=_.recordIsArray?s.index:i,!s.virtual))if(!n||s.noCopy){if(s.parentField&&_.parentModel&&(h||(h=e.get(_.parentModel))&&!c&&_.parentRecordId&&(c=h.getRecord(_.parentRecordId)),c)){l[a]=h.getValue(c,s.parentField);continue}u="",g&&void 0!==(f=s.defaultValue)&&(u="function"==typeof f?f(this,n):f),l[a]=u}else l[a]=n[a];if(h&&e.release(_.parentModel),this._identityKeys&&this._assignTempIdentity(l),this._metaKey&&(l[this._metaKey]={}),"tree"===_.shape&&(this._parentIdKey&&(l[this._parentIdKey]=this._getIdentity(r)),d=[],l[this._childrenKey]=d,n&&(o=n[this._childrenKey])))for(i=0;i<o.length;i++)d.push(this._initRecord(null,o[i],l));return l},_assignTempIdentity:function(e){var t;for(t=0;t<this._identityKeys.length;t++)e[this._identityKeys[t]]=this._options.genIdPrefix+this._nextInsertId,this._nextInsertId+=1},_getIdentity:function(e,t){var n,r=null;if(void 0!==this._identityKeys)if(1===this._identityKeys.length)r=e[this._identityKeys[0]]+"";else for(r=[],n=0;n<this._identityKeys.length;n++)r.push(e[this._identityKeys[n]]+"");else null!=t&&(r=t+"");return null!==r?v(r):r},_getPrimaryKey:function(e){var t,n;if(void 0!==this._identityKeys)for(n=[],t=0;t<this._identityKeys.length;t++)n.push(e[this._identityKeys[t]]+"");return n},_getType:function(e){var t="default",n=this._options;return e&&void 0!==this._typeKey&&(null!==(t=e[this._typeKey])&&"object"==typeof t&&t.hasOwnProperty("v")&&(t=t.v),t||(t="default")),n.types[t]||n.types.default},_getRecordById:function(e){var t=this._index[v(e)];return t?t.record:null},_removeRecord:function(e,t){var n,r,i=this._options;"table"===i.shape?n=this._data:"tree"===i.shape&&(n=t.parent[this._childrenKey],delete t.parent),n.splice(n.indexOf(t.record),1),r=v(e),delete this._index[r],t.sel&&(delete this._selection[r],this._selectionCount-=1)},_addChange:function(e){var t=this._changes.indexOf(e);t>=0&&this._changes.splice(t,1),this._changes.push(e)},_removeChange:function(e){var t=this._changes.indexOf(e);t>=0&&!e.deleted&&!e.updated&&!e.inserted&&this._changes.splice(t,1)},_removeError:function(e){var t=this._errors.indexOf(e);t>=0&&this._errors.splice(t,1)},_addParentItems:function(t){var n,r,i,s,a,o,d={values:[]},l=this._options;if(l.parentModel&&l.parentRecordId){for(n in l.fields)l.fields.hasOwnProperty(n)&&(r=l.fields[n]).parentField&&(i||(i=e.get(l.parentModel))&&!s&&(s=i.getRecord(l.parentRecordId),o=i.getRecordMetadata(l.parentRecordId)),s&&(a={n:r.parentField,v:i.getValue(s,r.parentField)},d.values.push(a)));o&&(o.salt&&(d.salt=o.salt),o.protected&&(d.protected=o.protected)),i&&e.release(l.parentModel),t.parentRecordId=l.parentRecordId,d.values.length>0&&(t.parentItems=d)}},_updateAggregates:function(){var e,t,n,r,i,s,a=this._options.fields,o=[];if(!(this._staleAggFields.length<=0)){for(e=0;e<this._staleAggFields.length;e++)for(n=a[r=this._staleAggFields[e]],t=0;t<n.aggregates.length;t++)"string"==typeof(i=n.aggregates[t])&&(i=M[i]),(s={name:i.name,fieldName:r,key:this.getFieldKey(this._staleAggFields[e]),state:{},agg:i}).agg.init(s.state,n.dataType),o.push(s);this.forEach((function(e,t,n){var r,i,a,d=this.getRecordMetadata(n);for(r=0;r<o.length;r++)s=o[r],d.agg?d.agg===s.name&&(a=e[s.key],i=s.agg.get(s.state,!d.grandTotal)+"",e[s.key]=i,p(this,"set",{oldValue:a,oldIdentity:null,recordId:n,record:e,field:s.fieldName})):d.deleted||(i=e[s.key],s.agg.add(s.state,i))}),this),this._staleAggFields=[]}},_checkAggregates:function(e){var t;if(e)this._aggregatedFields[e]&&this._staleAggFields.indexOf(e)<0&&(this._staleAggFields.push(e),this._debouncedUpdateAggregates());else for(t in this._aggregatedFields)this._aggregatedFields.hasOwnProperty(t)&&this._checkAggregates(t)},_recalculate:function(e){this.forEach((function(t,n,r){var i=this.getRecordMetadata(r);i.agg||b(this,i,e,!0)}),this)}},A={shape:"table",recordIsArray:!1,hasTotalRecords:!1,genIdPrefix:"t",regionId:null,ajaxIdentifier:null,pageItemsToSubmit:null,regionData:{},fetchData:{},saveData:{},version:1,parentModel:null,parentRecordId:null,editable:!1,onlyMarkForDelete:!0,identityField:null,typeField:null,childrenField:null,parentIdentityField:null,sequenceField:null,metaField:null,sequenceStep:10,saveSelection:!1,types:{default:{validChildren:!0,operations:{canAdd:!0,canEdit:!0,canDelete:!0,canDrag:!0,drag:{normal:"move",ctrl:"copy"},externalDrag:{normal:"add"}}}},check:null,sortCompare:null,paginationType:"none",pageSize:100,preFetch:!1},P={table:1,tree:1,record:1},T={none:1,one:1,progressive:1};function E(e){var t,n=g(e);return(t=s[n[0]])&&(t=n[1]?t.instances[n[1]]:t.model),t}function q(e,t,n,r){var i,a,o=r?g(r):null,d=[];function l(r){var i=!(!n&&!r._options.regionId);return i&&("change"===e?i=r.isChanged():"error"===e&&(i=r.hasErrors()),i&&t&&(i=function(e){for(var t,n=e,r=g(n.modelId());r;){if(r[0]===o[0]&&(r[1]===o[1]||null===o[1]))return!0;r=null,(t=n.getOption("parentModel"))&&(n=E(t))&&(r=g(t))}return!1}(r))),i}function h(e,t){d.push({id:e,model:t})}function c(e,t){var n;for(n in e.model&&l(e.model)&&h(t,e.model),e.instances)e.instances.hasOwnProperty(n)&&l(e.instances[n])&&h([t,n],e.instances[n])}if(o||(t=!1),!t&&o&&o[0])a=o[0],(i=s[a])&&(o[1]?i.instances[o[1]]&&l(i.instances[o[1]])&&h([a,o[1]],i.instances[o[1]]):c(i,a));else for(a in s)s.hasOwnProperty(a)&&c(i=s[a],a);return d}function k(e){var t;(t=a.indexOf(e))>=0&&a.splice(t,1)}e.create=function(t,o,c,u,f,_){var y,v,I,m,w,R,F,x,K,b,D,O,C=g(t),E=Object.create(S);function q(e,t){var r=v.fields[e];(r.calcValue||r.dependsOn||r.aggregates&&r.aggregates.length>0)&&(n.warn("Model "+t+" field does not support calculations"),delete r.calcValue,delete r.dependsOn)}if(E.name=C[0],E.instance=C[1],E._requestsInProgress={},E._listeners=[],E._waitingPages=[],I=o.fields,E._options=l(!0,{},A,o),E._options.fields=I,!(v=E._options).fields)throw new Error("The fields option is required");if(!P[v.shape])throw new Error("Invalid shape option: "+v.shape);if(!T[v.paginationType])throw new Error("Invalid paginationType option: "+v.paginationType);if(v.editable&&!v.identityField)throw new Error("An editable model requires an identityField");if("tree"===v.shape&&!v.childrenField)throw new Error("A tree shaped model requires a childrenField");if("table"===v.shape&&"none"===v.paginationType&&void 0===o.hasTotalRecords&&(v.hasTotalRecords=!0),E._dependentFields={},E._calculatedFields=[],E._aggregatedFields={},E._aggregateRecs=[],function(e,t,n,s,a){var o,d,l,h,c,u,f,g,_,p,y=[],v={},I=function(e){var t=e.target.id;E._recalculate(E._dependentFields[":"+t])};for(l in e)if(e.hasOwnProperty(l)){if((h=e[l]).calcValue&&n.push(l),c=h.dependsOn)for(o=0;o<c.length;o++){if(":"===(f=c[o]).substr(0,1)){if(g=f.substr(1),!apex.item(g).node)throw new Error("Field '"+l+"' depends on unknown item '"+g+"'");y.push(g)}else if(!e[f])throw new Error("Field '"+l+"' depends on unknown field '"+f+"'");_=l,t[p=f]||(t[p]=[]),t[p].push(_)}if(h.aggregates){for(o=0;o<h.aggregates.length;o++){if("string"==typeof(d=h.aggregates[o])&&!M[d]||"object"==typeof d&&!(d.name&&d.init&&d.add&&d.get))throw new Error("Field '"+l+"' has invalid aggregate");v[u=d.name||d]||a.push(u),v[u]=1}s[l]=1}}y.length>0&&(E._externalItems$=i(y.map((function(e){return"#"+r.escapeCSS(e)})).join(",")),E._externalItems$.on("change",I),E._externalItemsHandler=I)}(v.fields,E._dependentFields,E._calculatedFields,E._aggregatedFields,E._aggregateRecs),E._staleAggFields=[],E._debouncedUpdateAggregates=r.debounce((function(){E._updateAggregates()}),250),E._nextInsertId=1e3,v.identityField)if(h(v.identityField))for(E._identityKeys=[],y=0;y<v.identityField.length;y++)E._identityKeys.push(E.getFieldKey(v.identityField[y])),q(v.identityField[y],"identity");else E._identityKeys=[E.getFieldKey(v.identityField)],q(v.identityField,"identity");if(v.typeField){if(E._typeKey=E.getFieldKey(v.typeField),void 0===E._typeKey)throw new Error("Type field not found: "+v.typeField);q(v.typeField,"type")}if(v.childrenField){if(E._childrenKey=E.getFieldKey(v.childrenField),void 0===E._childrenKey)throw new Error("Children field not found: "+v.childrenField);q(v.childrenField,"children")}if(v.parentIdentityField){if(E._parentIdKey=E.getFieldKey(v.parentIdentityField),void 0===E._parentIdKey)throw new Error("Parent identity field not found: "+v.parentIdentityField);q(v.parentIdentityField,"parentIdentity")}if(v.sequenceField){if(E._sequenceKey=E.getFieldKey(v.sequenceField),void 0===E._sequenceKey)throw new Error("Sequence field not found: "+v.sequenceField);q(v.sequenceField,"sequence")}if(v.metaField){if(E._metaKey=E.getFieldKey(v.metaField),void 0===E._metaKey)throw new Error("Meta field not found: "+v.metaField);q(v.metaField,"meta")}if("record"!==v.shape?v.identityField?E.getRecord=E._getRecordById:E.getRecord=E.recordAt:E.getRecord=function(){return E._data},E._clear(),c?(K="none"!==v.paginationType&&(null!=f?f:null==u||c.length<u),E._addData(0,0,c,u,K,_)):null!=u&&(E._totalRecords=u),v.parentModel&&v.parentRecordId&&!c&&(O=e.get(v.parentModel))){for(y in(D=O.getRecordMetadata(v.parentRecordId)).inserted&&(E._masterRecordIsInserted=!0,E._clear()),D.deleted&&(E._saveDataState(),E._masterRecordIsDeleted=!0,E._clear(),E._addData(0,0,[],0,!1,!1)),R=E._parentFieldsMap={},v.fields)v.fields.hasOwnProperty(y)&&(w=v.fields[y]).parentField&&(R[w.parentField]||(R[w.parentField]=[]),R[w.parentField].push(y));E.parentModelViewId=O.subscribe({onChange:function(t,n){var r,i;if("delete"===t||"revert"===t||"refreshRecords"===t||"clearChanges"===t){for(i=n.recordIds||n.deletedIds,r=0;r<i.length;r++)if(i[r]===v.parentRecordId){"delete"===t?(E._saveDataState(),E._masterRecordIsDeleted=!0,E._clear(),E._addData(0,0,[],0,!1,!1),p(E,"refresh",{})):"revert"!==t&&"refreshRecords"!==t||!E._masterRecordIsDeleted?"refreshRecords"===t&&n.newIds&&n.newIds[E.instance]||"clearChanges"===t&&E._masterRecordIsDeleted&&delete E._saveState:(delete E._masterRecordIsDeleted,E._restoreDataState(),p(E,"refresh",{}));break}"clearChanges"===t&&E._masterRecordIsInserted&&delete E._masterRecordIsInserted}else"set"===t&&(n.oldIdentity||n.recordId)===v.parentRecordId?((F=n.field)in R&&(m=R[F],x=O.getValue(n.record,F),E.forEach((function(e){var t,r;if(!E._metaKey||!e[E._metaKey].agg)for(t=0;t<m.length;t++)r=m[t],n.oldValue===E.getValue(e,r)&&E.setValue(e,r,x)}))),n.oldIdentity&&(v.parentRecordId=n.recordId,e.renameInstance(E.modelId(),n.recordId))):"refresh"===t&&E._masterRecordIsDeleted&&(delete E._masterRecordIsDeleted,E._restoreDataState(),p(E,"refresh",{}))}}),e.release(v.parentModel)}return a.length>=d&&(b=function(){var e,t;for(e=0;e<a.length;e++)if(!(t=a[e]).isChanged())return t;return null}())&&(n.info("Model: cache overflow; remove model from cache: "+b.modelId()),e.destroy(g(b.modelId()))),(b=s[C[0]])||(b={instances:{},instancesRef:{}},s[C[0]]=b),C[1]?(b.instancesRef[C[1]]=1,b.instances[C[1]]=E):(b.modelRef=1,b.model=E),n.info("Model: created model: "+t+" refCount: 1"),E},e.list=function(e,t,n){return q(null,n,e,t).map((function(e){return e.id}))},e.getStats=function(){var e,t,n,r,i,o=[];for(e in s)if(s.hasOwnProperty(e))for(i in(r=(t=s[e]).model)&&(n={name:r.name,instance:null,refCount:t.modelRef,cachePos:a.indexOf(r),subscribers:r._listeners.length,progressViews:r._listeners.map((function(e){return e.progressView||null}))},o.push(n)),t.instances)t.instances.hasOwnProperty(i)&&(n={name:(r=t.instances[i]).name,instance:r.instance,refCount:t.instancesRef[i],cachePos:a.indexOf(r),subscribers:r._listeners.length,progressViews:r._listeners.map((function(e){return e.progressView||null}))},o.push(n));return o},e.anyChanges=function(e,t,n){return q("change",n,e,t).length>0},e.anyErrors=function(e,t,n){return q("error",n,e,t).length>0},e.addChangesToSaveRequest=function(e,t,n){var r,i,s=[],a=q("change",n,!1,t);if(a.length<=0)return null;for(r=0;r<a.length;r++)(i=a[r].model.addChangesToSaveRequest(e))&&s.push(i);return function(e){var t;for(t=0;t<s.length;t++)s[t](e)}},e.save=function(e,n,r,i,s){var a,o,d,l,h;if(e=e||{},n=n||{},l=q("change",i,!1,r),o=apex.model.addChangesToSaveRequest(e,r,i)){if(r&&void 0===n.loadingIndicator&&void 0===n.loadingIndicatorPosition){for(h=[],a=1;a<l.length;a++)h.push(l[a].model);n.loadingIndicator=I(l[0].model,h)}return o(d=(s||t.plugin)(e,n)),d}return null},e.get=function(e){var t,r,i,a=g(e);return(t=s[a[0]])&&(a[1]?(r=t.instances[a[1]])&&(i=t.instancesRef[a[1]]+=1):(r=t.model)&&(i=t.modelRef+=1),r&&(k(r),n.info("Model: get model: "+e+" refCount: "+i))),r},e.renameInstance=function(e,t){var r,i,a=g(e);(r=s[a[0]])&&a[1]&&((i=r.instances[a[1]]).instance=t,delete r.instances[a[1]],r.instances[t]=i,n.info("Model: rename model "+a[0]+" instance: "+a[1]+" to "+t),p(i,"instanceRename",{oldInstance:a[1],newInstance:t}))},e.release=function(t){var r,i,o=g(t);(r=s[o[0]])&&(o[1]?(i=r.instancesRef[o[1]]-=1,r=r.instances[o[1]]):(i=r.modelRef-=1,r=r.model),n.info("Model: release model: "+t+" refCount: "+i),i<=0&&(r._options.parentModel&&E(r._options.parentModel)?(n.info("Model: save in cache model: "+t),function(e){var t;(t=a.indexOf(e))>=0&&a.splice(t,1),a.push(e)}(r)):r.isChanged()||e.destroy(t)))},e.destroy=function(t){var r,i,a=g(t);function o(r){var i,s;r&&(k(r),r.parentModelViewId&&(s=r._options.parentModel,(i=e.get(s))&&(i.unSubscribe(r.parentModelViewId),e.release(s))),r._externalItems$&&r._externalItems$.off("change",r._externalItemsHandler),r._data=null,r._index=null,r._selection=null,n.info("Model: destroy model: "+t))}if(r=s[a[0]]){if(a[1])o(r.instances[a[1]]),delete r.instancesRef[a[1]],delete r.instances[a[1]];else if(o(r.model),delete r.model,delete r.modelRef,"string"==typeof t&&!a[1])for(i in r.instances)r.instances.hasOwnProperty(i)&&(o(r.instances[i]),delete r.instancesRef[i],delete r.instances[i]);0!==Object.keys(r.instances).length||r.model||delete s[a[0]]}},e.getMaxCachedModels=function(){return d},e.setMaxCachedModels=function(e){d=parseInt(e,10)||10}}(apex.model,apex.server,apex.debug,apex.util,apex.jQuery);